<%- include('partials/head.ejs') %>

<div class="max-w-5xl mx-auto mt-10 mb-20 px-6">
  <!-- Header + Search Bar -->
  <div
    class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4"
  >
    <h1 class="text-3xl font-bold text-gray-800">Report Overview</h1>

    <!-- Search Form -->
    <div class="flex w-full md:w-auto items-center gap-2">
      <form method="get" action="/tasks" class="flex w-full md:w-auto">
        <input
          type="text"
          name="q"
          value="<%= q %>"
          placeholder="Search by title or description..."
          class="border border-gray-300 rounded-l-lg py-2 px-4 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
        />

        <% if(t){ %>
        <input type="hidden" name="t" value="<%= t %>" />
        <% } %> <% if(p){ %>
        <input type="hidden" name="p" value="<%= p %>" />
        <% } %>

        <button
          type="submit"
          class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-r-lg shadow-md transition-colors"
        >
          Search
        </button>
      </form>

      <!-- Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ŸÅ€åŸÑÿ™ÿ± q -->
      <% if(q){ let queryWithoutQ = []; if(t) queryWithoutQ.push('t=' +
      encodeURIComponent(t)); if(p) queryWithoutQ.push('p=' +
      encodeURIComponent(p)); let urlWithoutQ = '/tasks' + (queryWithoutQ.length
      > 0 ? '?' + queryWithoutQ.join('&') : ''); %>
      <a
        href="<%= urlWithoutQ %>"
        title="Clear search"
        class="ml-2 text-gray-500 hover:text-gray-700"
      >
        ‚ùå
      </a>
      <% } %>
    </div>
  </div>

  <!-- Summary Section -->
  <div class="grid md:grid-cols-4 gap-6 mb-10">
    <div class="bg-gray-50 rounded-2xl p-5 shadow-sm border">
      <h3 class="text-sm uppercase text-gray-500 mb-2">Total Time</h3>
      <p class="text-2xl font-bold text-gray-800">
        <%= Math.floor(totalTime / 60) %>h <%= totalTime % 60 %>m
      </p>
    </div>

    <div class="bg-gray-50 rounded-2xl p-5 shadow-sm border">
      <h4
        class="text-sm uppercase text-gray-500 mb-2 flex justify-between items-center"
      >
        <span>Time by Tag</span>
        <% if (t) { let queryWithoutT = []; if (p) queryWithoutT.push('p=' +
        encodeURIComponent(p)); if (q) queryWithoutT.push('q=' +
        encodeURIComponent(q)); let urlWithoutT = '/tasks' +
        (queryWithoutT.length > 0 ? '?' + queryWithoutT.join('&') : ''); %>
        <a
          href="<%= urlWithoutT %>"
          title="Clear tag filter"
          class="ml-2 hover:text-gray-600"
        >
          ‚ùå
        </a>
        <% } %>
      </h4>

      <ul class="space-y-1 text-gray-700 text-sm">
        <% for (let tag in timeByTag) { %>
        <li class="flex justify-between">
          <% let queryString = 't=' + encodeURIComponent(tag); if (p)
          queryString += '&p=' + encodeURIComponent(p); if (q) queryString +=
          '&q=' + encodeURIComponent(q); %>
          <a href="/tasks?<%= queryString %>">
            <span class="font-medium text-gray-800"><%= tag %></span>
            <span
              ><%= Math.floor(timeByTag[tag] / 60) %>h <%= timeByTag[tag] % 60
              %>m</span
            >
          </a>
        </li>
        <% } %>
      </ul>
    </div>

    <div class="bg-gray-50 rounded-2xl p-5 shadow-sm border">
      <h4
        class="text-sm uppercase text-gray-500 mb-2 flex justify-between items-center"
      >
        <span>Time by Project</span>
        <% if (p) { let queryWithoutP = []; if (t) queryWithoutP.push('t=' +
        encodeURIComponent(t)); if (q) queryWithoutP.push('q=' +
        encodeURIComponent(q)); let urlWithoutP = '/tasks' +
        (queryWithoutP.length > 0 ? '?' + queryWithoutP.join('&') : ''); %>
        <a
          href="<%= urlWithoutP %>"
          title="Clear project filter"
          class="ml-2 hover:text-gray-600"
        >
          ‚ùå
        </a>
        <% } %>
      </h4>

      <ul class="space-y-1 text-gray-700 text-sm">
        <% for (let project in timeByProject) { %>
        <li class="flex justify-between">
          <% let queryString = 'p=' + encodeURIComponent(project); if (t)
          queryString += '&t=' + encodeURIComponent(t); if (q) queryString +=
          '&q=' + encodeURIComponent(q); %>
          <a href="/tasks?<%= queryString %>">
            <span class="font-medium text-gray-800"><%= project %></span>
            <span
              ><%= Math.floor(timeByProject[project] / 60) %>h <%=
              timeByProject[project] % 60 %>m</span
            >
          </a>
        </li>
        <% } %>
      </ul>
    </div>

    <div
      class="bg-gray-50 rounded-2xl p-5 shadow-sm border flex flex-col justify-center items-center"
    >
      <h4 class="text-sm uppercase text-gray-500 mb-2">AVG Score</h4>
      <% const roundedAvg = Math.round(Number(avgScore) || 0); %>
      <div class="flex justify-center text-yellow-500 text-3xl">
        <% for (let i = 0; i < roundedAvg; i++) { %>
        <span class="mr-0.5">‚≠ê</span>
        <% } %>
      </div>
      <p class="text-gray-600 text-sm mt-1"><%= roundedAvg %>/5</p>
    </div>
  </div>

  <!-- Tasks List -->
  <div class="space-y-4">
    <% tasks.forEach(function(task){ const hours = Math.floor(Number(task.time
    || 0) / 60); const minutes = Number(task.time || 0) % 60; const scoreCount =
    Math.max(0, Math.floor(Number(task.score) || 0)); %>
    <div
      class="bg-white rounded-2xl p-5 shadow hover:shadow-md border transition-all duration-200"
    >
      <div class="flex justify-between items-start mb-3">
        <div class="text-lg font-semibold text-gray-800"><%= task.title %></div>

        <div class="flex gap-2">
          <form method="get" action="/tasks/form/<%= task._id %>">
            <button
              class="bg-blue-200 hover:bg-blue-300 text-blue-800 rounded-full p-2 text-xs font-semibold shadow-sm transition-colors"
              type="submit"
              title="Edit Task"
            >
              ‚úèÔ∏è
            </button>
          </form>

          <form
            method="post"
            action="/tasks/remove/<%= task._id %>"
            onsubmit="return confirm('Are you sure you want to delete this task?');"
          >
            <button
              class="bg-red-200 hover:bg-red-300 text-red-800 rounded-full p-2 text-xs font-semibold shadow-sm transition-colors"
              type="submit"
              title="Delete Task"
            >
              üóëÔ∏è
            </button>
          </form>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
        <div
          class="bg-gray-200 px-2 py-0.5 rounded text-xs font-medium text-gray-700"
        >
          #<%= task.tag %>
        </div>

        <div class="text-gray-500">
          <%= new
          Date(task.created_at).toISOString().slice(0,16).replace('T','') %>
        </div>

        <div class="text-gray-700 font-medium">
          ‚è± <%= hours %>h <%= minutes %>m
        </div>

        <div class="text-gray-700 font-medium">üìÅ <%= task.project %></div>

        <div class="flex items-center text-yellow-500 ml-2">
          <% for (let i = 0; i < scoreCount; i++) { %>
          <span class="mr-0.5">‚≠ê</span>
          <% } %>
        </div>
      </div>

      <% if (task.description) { %>
      <p class="text-gray-600 mt-3 text-sm leading-relaxed border-t pt-2">
        <%- task.descriptionHtml %>
      </p>
      <% } %>
    </div>
    <% }) %>
  </div>
</div>

<%- include('partials/foot.ejs') %>
