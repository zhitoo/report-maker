<%- include('partials/head.ejs') %>

<div class="max-w-5xl mx-auto mt-10 mb-20 px-6">
  <!-- Header + Search Bar -->
  <div
    class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4"
  >
    <h1 class="text-3xl font-bold text-gray-800">Report Overview</h1>

    <!-- Search Form -->
    <form method="get" action="/tasks" class="flex w-full md:w-auto">
      <input
        type="text"
        name="q"
        value="<%= typeof q !== 'undefined' ? q : '' %>"
        placeholder="Search by tag or project..."
        class="border border-gray-300 rounded-l-lg py-2 px-4 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button
        type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-r-lg shadow-md transition-colors"
      >
        Search
      </button>
    </form>
  </div>

  <!-- Summary Section -->
  <div class="grid md:grid-cols-4 gap-6 mb-10">
    <div class="bg-gray-50 rounded-2xl p-5 shadow-sm border">
      <h3 class="text-sm uppercase text-gray-500 mb-2">Total Time</h3>
      <p class="text-2xl font-bold text-gray-800">
        <%= Math.floor(totalTime / 60) %>h <%= totalTime % 60 %>m
      </p>
    </div>

    <div class="bg-gray-50 rounded-2xl p-5 shadow-sm border">
      <h4 class="text-sm uppercase text-gray-500 mb-2">Time by Tag</h4>
      <ul class="space-y-1 text-gray-700 text-sm">
        <% for (let tag in timeByTag) { %>
        <li class="flex justify-between">
          <span class="font-medium text-gray-800"><%= tag %></span>
          <span
            ><%= Math.floor(timeByTag[tag] / 60) %>h <%= timeByTag[tag] % 60
            %>m</span
          >
        </li>
        <% } %>
      </ul>
    </div>

    <div class="bg-gray-50 rounded-2xl p-5 shadow-sm border">
      <h4 class="text-sm uppercase text-gray-500 mb-2">Time by Project</h4>
      <ul class="space-y-1 text-gray-700 text-sm">
        <% for (let project in timeByProject) { %>
        <li class="flex justify-between">
          <span class="font-medium text-gray-800"><%= project %></span>
          <span
            ><%= Math.floor(timeByProject[project] / 60) %>h <%=
            timeByProject[project] % 60 %>m</span
          >
        </li>
        <% } %>
      </ul>
    </div>

    <div
      class="bg-gray-50 rounded-2xl p-8 shadow-sm border flex flex-col justify-center items-center"
    >
      <% const roundedAvg = Math.round(avgScore); let avgEmoji = "üòê";
      if(roundedAvg <= 1) avgEmoji = "üò°"; else if(roundedAvg === 2) avgEmoji =
      "üòû"; else if(roundedAvg === 3) avgEmoji = "üòê"; else if(roundedAvg === 4)
      avgEmoji = "üôÇ"; else if(roundedAvg >= 5) avgEmoji = "üòÑ"; %>
      <p class="text-5xl"><%= avgEmoji %></p>
    </div>
  </div>

  <!-- Tasks List -->
  <div class="space-y-4">
    <% tasks.forEach(function(task){ %>
    <div
      class="bg-white rounded-2xl p-5 shadow hover:shadow-md border transition-all duration-200"
    >
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-3"
      >
        <div class="flex flex-wrap gap-3 items-center text-sm text-gray-600">
          <div class="text-gray-800 font-semibold"><%= task.title %></div>
          <div
            class="bg-gray-200 px-2 py-0.5 rounded text-xs font-medium text-gray-700"
          >
            #<%= task.tag %>
          </div>
          <div class="text-gray-500">
            <%= new
            Date(task.created_at).toISOString().slice(0,16).replace('T',' ') %>
          </div>
          <% const hours = Math.floor(task.time / 60); const minutes = task.time
          % 60; %>
          <div class="text-gray-700 font-medium">
            ‚è± <%= hours %>h <%= minutes %>m
          </div>
          <div class="text-gray-700 font-medium">üìÅ <%= task.project %></div>
        </div>

        <div class="flex gap-2 items-center">
          <% let emoji = "üòê"; if(task.score === 1) emoji = "üò°"; else
          if(task.score === 2) emoji = "üòû"; else if(task.score === 3) emoji =
          "üòê"; else if(task.score === 4) emoji = "üôÇ"; else if(task.score ===
          5) emoji = "üòÑ"; %>
          <div class="text-xl"><%= emoji %></div>

          <form method="get" action="/tasks/form/<%=task._id%>">
            <button
              class="bg-yellow-500 hover:bg-yellow-600 transition-colors rounded-lg py-1.5 px-3 text-xs font-semibold text-white shadow-sm"
              type="submit"
            >
              Update
            </button>
          </form>
          <form method="post" action="/tasks/remove/<%=task._id%>">
            <button
              class="bg-red-600 hover:bg-red-700 transition-colors rounded-lg py-1.5 px-3 text-xs font-semibold text-white shadow-sm"
              type="submit"
            >
              Delete
            </button>
          </form>
        </div>
      </div>

      <% if (task.description) { %>
      <p class="text-gray-600 mt-2 text-sm leading-relaxed border-t pt-2">
        <%- task.descriptionHtml %>
      </p>
      <% } %>
    </div>
    <% }) %>
  </div>
</div>

<%- include('partials/foot.ejs') %>
